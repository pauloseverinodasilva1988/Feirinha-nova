<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="C:\xampp\htdocs\Feirinha\imagens\logo_brico.png" type="image/png">
    <title>Histórico de Análises - Sistema de Qualidade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --vinho-escuro: #800020;
            --vinho-claro: #B03A5A;
            --dourado: #FFD700;
            --aprovado: #28A745;
            /* --atencao: #FFC107; */ /* Removido */
            --reprovado: #DC3545;
            --texto-claro: #F8F8F8;
            --texto-escuro: #333333;
            --fundo-principal: #fdf2f2;
            --fundo-card: #ffe0e0;
            --borda-card: #f0c0c0;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--fundo-principal);
            color: var(--texto-escuro);
        }

        .container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-frame {
            background-color: var(--fundo-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* NEW: Style for the logo */
        .header-logo {
            margin-right: 60px; /* Space between logo and other header info */
        }

        .header-logo img {
            max-height: 120px; /* Adjust as needed */
            width: auto;
        }
        /* END NEW */


        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-button, .action-button {
            background-color: var(--dourado);
            color: var(--vinho-escuro);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

        .nav-button:hover, .action-button:hover {
            background-color: #e0c800;
        }

        .filters-frame {
            background-color: var(--fundo-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-weight: bold;
            color: var(--vinho-escuro);
            font-size: 14px;
        }

        .filter-input, .filter-select {
            padding: 8px;
            border: 1px solid var(--borda-card);
            border-radius: 4px;
            background-color: var(--texto-claro);
            color: var(--texto-escuro);
        }

        .main-content {
            /* Alterado para uma única coluna, empilhando os elementos */
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-table-frame, .charts-frame {
            background-color: var(--fundo-card);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--borda-card);
            border-radius: 5px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--borda-card);
        }

        .history-table th {
            background-color: var(--vinho-claro);
            color: var(--texto-claro);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .history-table tr:hover {
            background-color: rgba(255, 215, 0, 0.1);
        }

        .conformidade-aprovado {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--aprovado);
            font-weight: bold;
        }

        /* .conformidade-atencao {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--atencao);
            font-weight: bold;
        } */ /* Removido */

        .conformidade-reprovado {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--reprovado);
            font-weight: bold;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }

        .stats-summary {
            background-color: var(--vinho-claro);
            color: var(--texto-claro);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-frame">
            <div class="header-logo">
                <img src="imagens/logo_brico.png" alt="Logo Brico">
            </div>
            <h1 style="color: var(--vinho-escuro); margin: 0;">Histórico de Análises de Qualidade</h1>
            <div class="nav-buttons">
                <a href="C:\xampp\htdocs\Feirinha\index (2).html" class="nav-button">Voltar para Análise</a>
                <button class="nav-button" onclick="printScreen()">Imprimir Tela</button>
            </div>
        </div>

        <div class="filters-frame">
            <h3 style="color: var(--vinho-escuro); margin-top: 0;">Filtros e Pesquisa</h3>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Produto:</label>
                    <input type="text" id="filtro-produto" class="filter-input" placeholder="Nome ou código do produto">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Data Inicial:</label>
                    <input type="date" id="filtro-data-inicial" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Data Final:</label>
                    <input type="date" id="filtro-data-final" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Conformidade:</label>
                    <select id="filtro-conformidade" class="filter-select">
                        <option value="">Todas</option>
                        <option value="aprovado">Aprovado</option>
                        <option value="reprovado">Reprovado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Dimensão:</label>
                    <select id="filtro-dimensao" class="filter-select">
                        <option value="">Todas</option>
                        <option value="peso">Peso</option>
                        <option value="comprimento">Comprimento</option>
                        <option value="altura">Altura</option>
                        <option value="largura">Largura</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-button" onclick="aplicarFiltros()">Aplicar Filtros</button>
                <button class="action-button" onclick="limparFiltros()">Limpar Filtros</button>
                <button class="action-button" onclick="exportarDados()">Exportar Dados</button>
                <button class="action-button" onclick="gerarRelatorioNaoConformidade()">Relatório de Não Conformidades</button>
            </div>
        </div>

        <div class="stats-summary" id="estatisticas-resumo">
            <h3 style="margin-top: 0;">Resumo Estatístico</h3>
            <div class="stats-row">
                <span>Total de Análises:</span>
                <span id="total-analises">0</span>
            </div>
            <div class="stats-row">
                <span>Não Conformidades:</span>
                <span id="total-nao-conformidades">0</span>
            </div>
            <div class="stats-row">
                <span>Taxa de Conformidade:</span>
                <span id="taxa-conformidade">0%</span>
            </div>
        </div>

        <div class="main-content">
            <div class="data-table-frame">
                <h3 style="color: var(--vinho-escuro); margin-top: 0;">Dados Históricos</h3>
                <div class="table-container">
                    <table class="history-table" id="tabela-historico">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Produto</th>
                                <th>Dimensão</th>
                                <th>Valor</th>
                                <th>Limite Min</th>
                                <th>Limite Max</th>
                                <th>Status</th>
                                <th>Desvio</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-historico-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="charts-frame">
                <h3 style="color: var(--vinho-escuro); margin-top: 0;">Análise Gráfica</h3>
                
                <div class="chart-container">
                    <canvas id="grafico-conformidade"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="grafico-tendencia"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="grafico-peso"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="grafico-comprimento"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="grafico-altura"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="grafico-largura"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="grafico-por-produto"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PRODUTOS_CADASTRO completo (copiado do index.html para garantir os limites)
        const PRODUTOS_CADASTRO = {
            116: {nome: "Mini Pão Francês Sam's", peso_min: 27, peso_max: 36, comp_min: 7, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            117: {nome: "Baguete Mini Sam's", peso_min: 75, peso_max: 85, comp_min: 20, comp_max: 24, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 6.0},
            127: {nome: "Baguete Média - Lanche", peso_min: 122, peso_max: 130, comp_min: 27, comp_max: 30, alt_min: 3.0, alt_max: 4.5, larg_min: 4.0, larg_max: 5.5},
            128: {nome: "Pão Francês Pré-assado", peso_min: 68, peso_max: 75, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 7.0, larg_min: 5.5, larg_max: 7.5},
            129: {nome: "Pão Francês Integral Pré Assado - 31% De Cereais Integrais", peso_min: 68, peso_max: 76, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 6.5, larg_min: 5.4, larg_max: 6.4},
            130: {nome: "Mini Pão Francês", peso_min: 30, peso_max: 36, comp_min: 7, comp_max: 9, alt_min: 4.5, alt_max: 5.5, larg_min: 4.5, larg_max: 5.5},
            132: {nome: "Baguete Mini", peso_min: 81, peso_max: 86, comp_min: 17, comp_max: 21, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            141: {nome: "Mini Pão Francês Integral Pré-assado - 31% De Cereais Integrais", peso_min: 38, peso_max: 47, comp_min: 7, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 5, larg_max: 5.5},
            142: {nome: "Baguetine", peso_min: 70, peso_max: 80, comp_min: 16, comp_max: 19, alt_min: 5, alt_max: 6, larg_min: 5.5, larg_max: 6.5},
            144: {nome: "Pão Francês Pré Assado Modelado", peso_min: 60, peso_max: 70, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 7.0, larg_min: 5.4, larg_max: 6.4},
            145: {nome: "Mini Pão Francês Integral Sam's", peso_min: 38, peso_max: 45, comp_min: 7, comp_max: 9, alt_min: 4.0, alt_max: 5.0, larg_min: 5.0, larg_max: 6.0},
            164: {nome: "Pão Bola Pacote", peso_min: 68, peso_max: 76, comp_min: 9.5, comp_max: 10.5, alt_min: 4.5, alt_max: 5.5, larg_min: 0.0, larg_max: 0.0},
            169: {nome: "Pão Bola Gourmet Pacote", peso_min: 68, peso_max: 71, comp_min: 9.5, comp_max: 10.5, alt_min: 4.5, alt_max: 5.5, larg_min: 0.0, larg_max: 0.0},
            170: {nome: "Mini Pão Francês Institucional Brico", peso_min: 30, peso_max: 40, comp_min: 7, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            171: {nome: "Pão Francês Tradicional Institucional Brico", peso_min: 60, peso_max: 70, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 6.5, larg_min: 5.4, larg_max: 6.4},
            172: {nome: "Baguete Tradicional Institucional Brico", peso_min: 70, peso_max: 79, comp_min: 17, comp_max: 21, alt_min: 3.0, alt_max: 4.5, larg_min: 4.0, larg_max: 5.5},
            173: {nome: "Baguete Mini Com Gergelim Institucional Brico", peso_min: 70, peso_max: 79, comp_min: 17, comp_max: 21, alt_min: 3.0, alt_max: 4.5, larg_min: 4.0, larg_max: 5.5},
            174: {nome: "Pão Francês Integral Institucional Brico - 31% De Cereais Integrais", peso_min: 68, peso_max: 76, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 6.5, larg_min: 5.4, larg_max: 6.4},
            175: {nome: "Mini Pão Francês Integral Institucional Brico - 31% De Cereais Integrais", peso_min: 38, peso_max: 47, comp_min: 7, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            183: {nome: "Mini Pão Francês Redondo", peso_min: 25, peso_max: 28, comp_min: 7, comp_max: 8, alt_min: 3.5, alt_max: 4.5, larg_min: 0.0, larg_max: 0.0},
            202: {nome: "Croissant Pequeno Assado", peso_min: 25, peso_max: 32, comp_min: 8, comp_max: 10.5, alt_min: 2.5, alt_max: 3.5, larg_min: 3.5, larg_max: 4.5},
            209: {nome: "Folhado de Maçã", peso_min: 95, peso_max: 105, comp_min: 10, comp_max: 12, alt_min: 1.5, alt_max: 2.5, larg_min: 5.5, larg_max: 6.5},
            210: {nome: "Folhado De Banana", peso_min: 95, peso_max: 105, comp_min: 10, comp_max: 12, alt_min: 1.5, alt_max: 2.5, larg_min: 5.5, larg_max: 6.5},
            214: {nome: "Folhado De Calabresa", peso_min: 95, peso_max: 105, comp_min: 10, comp_max: 12, alt_min: 1.5, alt_max: 2.5, larg_min: 5.5, larg_max: 6.5},
            235: {nome: "Mini Croissant Multigrão", peso_min: 25, peso_max: 32, comp_min: 8, comp_max: 10.5, alt_min: 2.5, alt_max: 3.5, larg_min: 3.5, larg_max: 4.5},
            236: {nome: "Pain Au Chocolat", peso_min: 25, peso_max: 35, comp_min: 6, comp_max: 7.5, alt_min: 0, alt_max: 0, larg_min: 0, larg_max: 0},
            313: {nome: "Baguete Mini Gergelim Sam's", peso_min: 79, peso_max: 87, comp_min: 20, comp_max: 24, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 6.0},
            330: {nome: "Baguete Frango com Requeijão", peso_min: 174, peso_max: 191, comp_min: 18, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            331: {nome: "Baguete Calabresa com Requeijão", peso_min: 174, peso_max: 191, comp_min: 18, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            333: {nome: "Baguete Mussarela com Requeijão", peso_min: 174, peso_max: 191, comp_min: 18, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            337: {nome: "Mini Baguete Especial Lanche", peso_min: 130, peso_max: 140, comp_min: 20, comp_max: 24, alt_min: 4.5, alt_max: 5.5, larg_min: 5.5, larg_max: 6.5},
            338: {nome: "Mini Baguete Especial Lanche Integral", peso_min: 130, peso_max: 140, comp_min: 20, comp_max: 24, alt_min: 4.5, alt_max: 5.5, larg_min: 5.5, larg_max: 6.5},
            357: {nome: "Baguete para Pão de Alho", peso_min: 54, peso_max: 66, comp_min: 13, comp_max: 16, alt_min: 4.3, alt_max: 4.5, larg_min: 5.3, larg_max: 5.8},
            361: {nome: "Baguete para Pão de Alho agranel", peso_min: 43, peso_max: 48, comp_min: 13, comp_max: 17, alt_min: 3.5, alt_max: 3.8, larg_min: 4.1, larg_max: 4.3},
            363: {nome: "Pão de Alho Tradicional Brico", peso_min: 61, peso_max: 70, comp_min: 13, comp_max: 17, alt_min: 3.5, alt_max: 3.8, larg_min: 4.1, larg_max: 4.3},
            409: {nome: "Mini Pão Doce Creme", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            410: {nome: "Mini Pão Doce Creme e Coco", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            450: {nome: "Bisnaga Doce", peso_min: 59, peso_max: 65, comp_min: 7, comp_max: 13, alt_min: 4.0, alt_max: 5.0, larg_min: 5.0, larg_max: 6.0},
            459: {nome: "Pão para Hot Dog Tradicional", peso_min: 63, peso_max: 72, comp_min: 16, comp_max: 20, alt_min: 4.2, alt_max: 4.8, larg_min: 5.0, larg_max: 8.0},
            466: {nome: "Pão Hambúrguer Brioche", peso_min: 68, peso_max: 74, comp_min: 9.5, comp_max: 10.5, alt_min: 4.5, alt_max: 5.5, larg_min: 0.0, larg_max: 0.0},
            471: {nome: "Pão de Hambúrguer Australiano", peso_min: 68, peso_max: 76, comp_min: 9.5, comp_max: 11, alt_min: 4.5, alt_max: 5.5, larg_min: 0.0, larg_max: 0.0},
            472: {nome: "Mini Pão de Hambúrguer Brioche", peso_min: 25, peso_max: 30, comp_min: 7, comp_max: 8, alt_min: 3.5, alt_max: 4.5, larg_min: 0.0, larg_max: 0.0},
            473: {nome: "Pão para Couvert", peso_min: 50, peso_max: 60, comp_min: 16, comp_max: 20, alt_min: 4.2, alt_max: 4.8, larg_min: 5.0, larg_max: 8.0},
            474: {nome: "Mini Pão de Hambúrguer Australiano", peso_min: 25, peso_max: 30, comp_min: 7, comp_max: 8, alt_min: 3.5, alt_max: 4.5, larg_min: 0.0, larg_max: 0.0},
            490: {nome: "Mini Pão Doce Creme De Avelã", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            491: {nome: "Mini Pão Doce com Recheio de Doce de Leite", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            503: {nome: "Pãozinho de leite", peso_min: 40, peso_max: 50, comp_min: 7, comp_max: 11, alt_min: 4.0, alt_max: 5.0, larg_min: 4.0, larg_max: 5.0},
            507: {nome: "Ciabatta Grande", peso_min: 104, peso_max: 113, comp_min: 17, comp_max: 19, alt_min: 3.0, alt_max: 5.0, larg_min: 7.0, larg_max: 9.0},
            601: {nome: "Pão de Queijo Coquetel Pacote 1Kg", peso_min: 15, peso_max: 18, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            603: {nome: "Pão de Queijo Maxi Pacote 1Kg", peso_min: 40, peso_max: 50, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            680: {nome: "Broinha Pacote 1Kg", peso_min: 25, peso_max: 27, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            690: {nome: "Chipa Pacote 1Kg", peso_min: 40, peso_max: 45, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            710: {nome: "Cookie Chocolate e Chocolate Branco", peso_min: 45, peso_max: 55, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            712: {nome: "Cookie Baunilha com Chocolate", peso_min: 45, peso_max: 55, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            816: {nome: "Mini Pão Francês Pacote 300g", peso_min: 30, peso_max: 40, comp_min: 7.0, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            817: {nome: "Baguette Congelada Pacote", peso_min: 104, peso_max: 112, comp_min: 20, comp_max: 24, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            818: {nome: "Mini Pão Francês Integral 300g - 31% De Cereais Integrais", peso_min: 38, peso_max: 47, comp_min: 7.0, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            819: {nome: "Pão Recheado Calabresa Congelado Pacote", peso_min: 105, peso_max: 122, comp_min: 16.0, comp_max: 18, alt_min: 3.0, alt_max: 4.5, larg_min: 5.5, larg_max: 6.0},
            823: {nome: "Pão de Queijo Tradicional Pacote 400g", peso_min: 15, peso_max: 18, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            824: {nome: "Pão Francês Congelado Pacote 220g", peso_min: 50, peso_max: 60, comp_min: 11.0, comp_max: 14, alt_min: 5.0, alt_max: 5.5, larg_min: 5.0, larg_max: 6.0},
            825: {nome: "Pão Francês Integral Pacote 220g - 31% De Cereais Integrais", peso_min: 50, peso_max: 60, comp_min: 11.0, comp_max: 14, alt_min: 5.0, alt_max: 5.5, larg_min: 5.0, larg_max: 6.0},
            827: {nome: "Mini Chipa Pacote 400g", peso_min: 13, peso_max: 17, comp_min: 0.0, comp_max: 0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            835: {nome: "Pão Francês Integral 280g - 31% De Cereais Integrais", peso_min: 68, peso_max: 76, comp_min: 13.0, comp_max: 16, alt_min: 5.0, alt_max: 6.5, larg_min: 5.4, larg_max: 6.4},
            859: {nome: "Baguete Integral Taeq - 31% De Cereais Integrais", peso_min: 87, peso_max: 96, comp_min: 20.0, comp_max: 24, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 6.0},
            861: {nome: "Mini Pão Francês Qualitá", peso_min: 30, peso_max: 40, comp_min: 7.0, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 6.0},
            862: {nome: "Baguete Qualitá", peso_min: 104, peso_max: 112, comp_min: 20.0, comp_max: 24, alt_min: 3.0, alt_max: 4.5, larg_min: 5.5, larg_max: 6.0},
            863: {nome: "Mini Pão Francês Integral Taeq - 31% De Cereais Integrais", peso_min: 23, peso_max: 32, comp_min: 7.0, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            881: {nome: "Bolo Arluno com Gotas de Chocolate", peso_min: 210, peso_max: 230, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            901: {nome: "Placa de Massa Folhada", peso_min: 680, peso_max: 720, comp_min: 33.0, comp_max: 35, alt_min: 1.0, alt_max: 2.0, larg_min: 20.0, larg_max: 25.0},
            906: {nome: "Pão Australiano Filão", peso_min: 265, peso_max: 275, comp_min: 24.0, comp_max: 31, alt_min: 5.0, alt_max: 6.0, larg_min: 6.0, larg_max: 7.0},
            1421: {nome: "Baguetine Pacote-312g", peso_min: 70, peso_max: 80, comp_min: 16.0, comp_max: 19, alt_min: 5.0, alt_max: 6.0, larg_min: 5.5, larg_max: 6.5},
            1442: {nome: "Pão Francês Pré Assado Modelado", peso_min: 60, peso_max: 70, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 7.0, larg_min: 5.4, larg_max: 6.4},
            1647: {nome: "Pão Bola Pacote com 6 unidades", peso_min: 68, peso_max: 71, comp_min: 9.5, comp_max: 10.5, alt_min: 4.5, alt_max: 5.5, larg_min: 0.0, larg_max: 0.0},
            1712: {nome: "Pão Francês Tradicional Institucional Sam's", peso_min: 60, peso_max: 70, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 6.5, larg_min: 5.4, larg_max: 6.4},
            2091: {nome: "Folhado de Maçã - Pacote", peso_min: 95, peso_max: 105, comp_min: 10.0, comp_max: 12, alt_min: 1.5, alt_max: 2.5, larg_min: 5.5, larg_max: 6.5},
            2120: {nome: "Croissant Pequeno Salgado", peso_min: 25, peso_max: 32, comp_min: 8.0, comp_max: 10.5, alt_min: 2.5, alt_max: 3.5, larg_min: 3.5, larg_max: 4.5},
            2141: {nome: "Folhado de Calabresa - Pacote", peso_min: 95, peso_max: 105, comp_min: 10.0, comp_max: 12, alt_min: 1.5, alt_max: 2.5, larg_min: 5.5, larg_max: 6.5},
            3301: {nome: "Baguete Frango com Requeijão - Pacote", peso_min: 174, peso_max: 191, comp_min: 18.0, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            3311: {nome: "Baguete Calabresa com Requeijão - Pacote", peso_min: 174, peso_max: 191, comp_min: 18.0, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            3313: {nome: "Baguete Calabresa com Requeijão - Pacote Sam's", peso_min: 174, peso_max: 191, comp_min: 18.0, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            3331: {nome: "Baguete Mussarela com Requeijão - Pacote", peso_min: 174, peso_max: 191, comp_min: 18.0, comp_max: 22, alt_min: 4.0, alt_max: 5.5, larg_min: 5.5, larg_max: 7.0},
            3631: {nome: "Pão de Alho Tradicional Brico Bandeja", peso_min: 314, peso_max: 347, comp_min: 0.0, comp_max: 0.0, alt_min: 0.0, alt_max: 0.0, larg_min: 0.0, larg_max: 0.0},
            3373: {nome: "Pão FHS Branco - 10cm", peso_min: 49, peso_max: 57, comp_min: 10, comp_max: 10.5, alt_min: 5, alt_max: 5.5, larg_min: 7, larg_max: 7.5},
            3374: {nome: "Pão FHS Branco - 15cm", peso_min: 75, peso_max: 83, comp_min: 15, comp_max: 15.5, alt_min: 5, alt_max: 5.5, larg_min: 7, larg_max: 7.5},
            3375: {nome: "Pão FHS Branco- 30cm", peso_min: 166, peso_max: 174, comp_min: 30, comp_max: 30.5, alt_min: 5, alt_max: 5.5, larg_min: 7, larg_max: 7.5},
            3383: {nome: "Pão FHS Marrom - 10cm", peso_min: 53, peso_max: 61, comp_min: 10, comp_max: 10.5, alt_min: 5, alt_max: 5.5, larg_min: 7, larg_max: 7.5},
            3384: {nome: "Pão FHS Marrom - 15cm", peso_min: 83, peso_max: 91, comp_min: 15, comp_max: 15.5, alt_min: 5, alt_max: 5.5, larg_min: 7, larg_max: 7.5},
            3385: {nome: "Pão FHS Marrom - 30cm", peso_min: 175, peso_max: 183, comp_min: 30, comp_max: 30.5, alt_min: 5, alt_max: 5.5, larg_min: 7, larg_max: 7.5},
            4091: {nome: "Mini Pão Doce Creme - Pacote", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            4101: {nome: "Mini Pão Doce Creme e Coco - Pacote", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            4111: {nome: "Mini Pão Doce Creme com Canela e Passas - Pacote", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0, larg_max: 0},
            4501: {nome: "Bisnaga Doce Pacote 620g", peso_min: 59, peso_max: 65, comp_min: 7, comp_max: 13, alt_min: 4, alt_max: 5, larg_min: 5, larg_max: 6},
            4591: {nome: "Pão para Hot Dog Tradicional Pacote com 4 unidades", peso_min: 63, peso_max: 72, comp_min: 16.0, comp_max: 20, alt_min: 4.2, alt_max: 4.8, larg_min: 5.0, larg_max: 8.0},
            4667: {nome: "Pão de Hambúrguer Brioche Pacote com 6 unidades", peso_min: 68, peso_max: 74, comp_min: 9.5, comp_max: 10.5, alt_min: 4.5, alt_max: 5.5, larg_min: 0.0, larg_max: 0.0},
            4901: {nome: "Mini Pão Doce Creme de Avelã - Pacote", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            4911: {nome: "Mini Pão Doce com Recheio de Doce de Leite - Pacote", peso_min: 40, peso_max: 47, comp_min: 6.5, comp_max: 7.5, alt_min: 3.2, alt_max: 3.8, larg_min: 0.0, larg_max: 0.0},
            5031: {nome: "Pãozinho de leite Pacote 450g", peso_min: 40, peso_max: 50, comp_min: 7, comp_max: 11, alt_min: 4.0, alt_max: 5.0, larg_min: 4.0, larg_max: 5.0},
            5071: {nome: "Ciabatta Grande - Pacote", peso_min: 104, peso_max: 113, comp_min: 17, comp_max: 19, alt_min: 3.0, alt_max: 5.0, larg_min: 7.0, larg_max: 9.0},
            5072: {nome: "Ciabatta Grande Pacote com 6 unidades", peso_min: 104, peso_max: 113, comp_min: 17, comp_max: 19, alt_min: 3.0, alt_max: 5.0, larg_min: 7.0, larg_max: 9.0},
            5073: {nome: "Ciabatta Grande Pacote Sam's", peso_min: 104, peso_max: 113, comp_min: 17, comp_max: 19, alt_min: 3.0, alt_max: 5.0, larg_min: 7.0, larg_max: 9.0},
            6802: {nome: "Mini Broinha Pacote 220g", peso_min: 5, peso_max: 7, comp_min: 0, comp_max: 0, alt_min: 0, alt_max: 0, larg_min: 0, larg_max: 0},
            7101: {nome: "Cookie Chocolate e Chocolate Branco - Pacote", peso_min: 45, peso_max: 55, comp_min: 0, comp_max: 0, alt_min: 0, alt_max: 0, larg_min: 0, larg_max: 0},
            7102: {nome: "Cookie Chocolate c/ Gotas de Chocolate Branco - Congelado", peso_min: 43, peso_max: 47, comp_min: 0, comp_max: 0, alt_min: 0, alt_max: 0, larg_min: 0, larg_max: 0},
            7121: {nome: "Cookie Baunilha com Chocolate", peso_min: 45, peso_max: 55, comp_min: 0, comp_max: 0, alt_min: 0, alt_max: 0, larg_min: 0, larg_max: 0},
            7122: {nome: "Cookie Baunilha c/ Gotas de Chocolate - Congelado", peso_min: 43, peso_max: 47, comp_min: 0, comp_max: 0, alt_min: 0, alt_max: 0, larg_min: 0, larg_max: 0},
            8163: {nome: "Mini Pão Francês 300g - SWIFT", peso_min: 29, peso_max: 40, comp_min: 7, comp_max: 9, alt_min: 3.5, alt_max: 4.5, larg_min: 4.5, larg_max: 5.5},
            8242: {nome: "Pão Francês Modelado Congelado Pacote", peso_min: 60, peso_max: 70, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 7.0, larg_min: 5.4, larg_max: 6.4},
            8243: {nome: "Pão Francês 180g - SWIFT", peso_min: 55, peso_max: 65, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 7.0, larg_min: 5.4, larg_max: 7},
            8244: {nome: "Pão Francês Congelado Pacote - Daki", peso_min: 60, peso_max: 70, comp_min: 13, comp_max: 16, alt_min: 5, alt_max: 7, larg_min: 5.4, larg_max: 6.4},
            8245: {nome: "Pão Francês 480g - SWIFT - [Pré-assado]", peso_min: 55, peso_max: 65, comp_min: 13, comp_max: 16, alt_min: 5, alt_max: 7, larg_min: 5.4, larg_max: 6.4},
            8253: {nome: "Pão Francês Integral 210g - SWIFT", peso_min: 68, peso_max: 72, comp_min: 13, comp_max: 16, alt_min: 5.0, alt_max: 6.5, larg_min: 5.4, larg_max: 6.4},
            9061: {nome: "Pão Australiano Filão - Pacote", peso_min: 265, peso_max: 275, comp_min: 24, comp_max: 31, alt_min: 5.0, alt_max: 6.0, larg_min: 6.0, larg_max: 7}
        };

        let dadosHistorico = [];
        let dadosFiltrados = [];
        let chartConformidade = null;
        let chartTendencia = null;
        let chartPeso, chartComprimento, chartAltura, chartLargura, chartPorProduto; // Declarar no escopo superior

        document.addEventListener('DOMContentLoaded', () => {
            carregarDadosHistorico();
            inicializarGraficos();
            aplicarFiltros();
            
            // Adicionar listeners para filtros em tempo real
            document.getElementById('filtro-produto').addEventListener('input', aplicarFiltros);
            document.getElementById('filtro-data-inicial').addEventListener('change', aplicarFiltros);
            document.getElementById('filtro-data-final').addEventListener('change', aplicarFiltros);
            document.getElementById('filtro-conformidade').addEventListener('change', aplicarFiltros);
            document.getElementById('filtro-dimensao').addEventListener('change', aplicarFiltros);
        });

        function carregarDadosHistorico() {
            dadosHistorico = [];
            
            // Carregar dados do localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Certifique-se de que estamos lendo apenas os dados de qualidade
                if (key && key.startsWith('qualidade_')) { 
                    try {
                        const dados = JSON.parse(localStorage.getItem(key));
                        // Adicionar 'id' ao objeto dados, para o caso de precisar identificar a sessão original
                        if (!dados.id) { 
                            dados.id = key; // Usa a chave do localStorage como ID da sessão
                        }
                        processarDadosParaHistorico(dados);
                    } catch (e) {
                        console.error('Erro ao processar dados da chave localStorage:', key, e);
                    }
                }
            }
            
            // Ordenar por data (do mais recente para o mais antigo)
            dadosHistorico.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Mapeamento para nomes de chaves abreviadas no PRODUTOS_CADASTRO (MESMO DO INDEX.HTML)
        const productDimensionKeyMap = {
            'peso': 'peso',
            'comprimento': 'comp',
            'altura': 'alt',
            'largura': 'larg'
        };

        // Propriedades para formatação decimal em cada dimensão
        const dimensionFormatProps = {
            'peso': { decimalPlaces: 0, unit: 'g' },
            'comprimento': { decimalPlaces: 1, unit: 'cm' },
            'altura': { decimalPlaces: 1, unit: 'cm' },
            'largura': { decimalPlaces: 1, unit: 'cm' }
        };

        function processarDadosParaHistorico(dadosSessao) {
            const produtoNome = dadosSessao.produto;
            // Garante que o código é um número para a busca no PRODUTOS_CADASTRO
            const codigoProduto = parseInt(dadosSessao.codigo); 
            const timestamp = dadosSessao.timestamp;
            const sessionId = dadosSessao.id;

            // Acessa o objeto de limites para o produto específico
            const limitesProduto = PRODUTOS_CADASTRO[codigoProduto]; 
            // const TOLERANCE_PERCENT = 0.05; // Não mais usada para classificar "Atenção"

            console.groupCollapsed(`DEBUG: Processando Sessão ID: ${sessionId} - Produto: ${produtoNome} (${codigoProduto})`);
            console.log(`Limites encontrados no PRODUTOS_CADASTRO para ${codigoProduto}:`, limitesProduto);

            ['peso', 'comprimento', 'altura', 'largura'].forEach(dimensao => {
                const baseKey = productDimensionKeyMap[dimensao]; // Use the mapping
                const minKey = `${baseKey}_min`;
                const maxKey = `${baseKey}_max`;
                const formatProps = dimensionFormatProps[dimensao];

                // Get limits from product, handle undefined gracefully
                const minLimite = (limitesProduto && typeof limitesProduto[minKey] === 'number') ? limitesProduto[minKey] : null;
                const maxLimite = (limitesProduto && typeof limitesProduto[maxKey] === 'number') ? limitesProduto[maxKey] : null;

                console.log(`  Dimensão: ${dimensao}, minKey: ${minKey}, maxKey: ${maxKey}`);
                console.log(`  minLimite:`, minLimite, `(Type: ${typeof minLimite})`);
                console.log(`  maxLimite:`, maxLimite, `(Type: ${typeof maxLimite})`);

                // Determine if limits should be displayed (i.e., not truly non-existent)
                const shouldDisplayLimits = (minLimite !== null && maxLimite !== null);

                let displayMin = shouldDisplayLimits ? minLimite.toFixed(formatProps.decimalPlaces) : 'N/A';
                let displayMax = shouldDisplayLimits ? maxLimite.toFixed(formatProps.decimalPlaces) : 'N/A';
                
                console.log(`  shouldDisplayLimits: ${shouldDisplayLimits}`);
                console.log(`  Display Min: ${displayMin}, Display Max: ${displayMax}`);

                if (dadosSessao.amostras[dimensao] && dadosSessao.amostras[dimensao].length > 0) {
                    dadosSessao.amostras[dimensao].forEach(valor => {
                        let status = 'N/A';
                        let desvio = 0;
                        
                        if (shouldDisplayLimits) { // Only calculate status if limits are present
                            if (valor >= minLimite && valor <= maxLimite) {
                                status = 'aprovado';
                                desvio = 0;
                            } else {
                                status = 'reprovado';
                                desvio = valor < minLimite ? minLimite - valor : valor - maxLimite;
                            }
                        }

                        dadosHistorico.push({
                            sessionId: sessionId,
                            timestamp: timestamp,
                            produto: produtoNome,
                            codigo: codigoProduto,
                            dimensao: dimensao,
                            valor: valor, // Store raw value
                            limiteMin: displayMin, // Store formatted display value
                            limiteMax: displayMax, // Store formatted display value
                            status: status,
                            desvio: Math.abs(desvio)
                        });
                    });
                }
            });
            console.groupEnd();
        }

        function aplicarFiltros() {
            const filtroProduto = document.getElementById('filtro-produto').value.toLowerCase().trim();
            const filtroDataInicial = document.getElementById('filtro-data-inicial').value;
            const filtroDataFinal = document.getElementById('filtro-data-final').value;
            const filtroConformidade = document.getElementById('filtro-conformidade').value;
            const filtroDimensao = document.getElementById('filtro-dimensao').value;
            
            console.log('Aplicando filtros:', {
                produto: filtroProduto,
                dataInicial: filtroDataInicial,
                dataFinal: filtroDataFinal,
                conformidade: filtroConformidade,
                dimensao: filtroDimensao,
                totalDados: dadosHistorico.length
            });
            
            dadosFiltrados = dadosHistorico.filter(item => {
                // Filtro por produto (nome ou código)
                if (filtroProduto) {
                    const produtoMatch = item.produto && item.produto.toLowerCase().includes(filtroProduto);
                    const codigoMatch = item.codigo && item.codigo.toString().includes(filtroProduto);
                    if (!produtoMatch && !codigoMatch) {
                        return false;
                    }
                }
                
                // Filtro por data inicial
                if (filtroDataInicial) {
                    const dataItem = new Date(item.timestamp).toISOString().split('T')[0];
                    if (dataItem < filtroDataInicial) return false;
                }
                
                // Filtro por data final
                if (filtroDataFinal) {
                    const dataItem = new Date(item.timestamp).toISOString().split('T')[0];
                    // Para incluir o dia final completo, a comparação deve ser <= ou ajustar para o fim do dia
                    if (dataItem > filtroDataFinal) return false; 
                }
                
                // Filtro por conformidade (agora só aprovado/reprovado)
                if (filtroConformidade && item.status !== filtroConformidade) {
                    return false;
                }
                
                // Filtro por dimensão
                if (filtroDimensao && item.dimensao !== filtroDimensao) {
                    return false;
                }
                
                return true;
            });
            
            console.log('Dados filtrados:', dadosFiltrados.length);
            
            atualizarTabela();
            atualizarEstatisticas();
            atualizarGraficos();
        }

        function atualizarTabela() {
            const tbody = document.getElementById('tabela-historico-body');
            tbody.innerHTML = '';
            
            dadosFiltrados.forEach((item, index) => {
                const row = tbody.insertRow();
                
                const dataFormatada = new Date(item.timestamp).toLocaleString('pt-BR');
                const statusClass = `conformidade-${item.status}`;
                
                // Get decimal places for current dimension for the 'Valor' column
                const decimalPlacesForValue = dimensionFormatProps[item.dimensao] ? dimensionFormatProps[item.dimensao].decimalPlaces : 2;

                row.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${item.produto}</td>
                    <td>${item.dimensao.charAt(0).toUpperCase() + item.dimensao.slice(1)}</td>
                    <td>${item.valor.toFixed(decimalPlacesForValue)}</td> <td>${item.limiteMin}</td> <td>${item.limiteMax}</td> <td class="${statusClass}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</td>
                    <td>${item.desvio.toFixed(2)}</td>
                    <td><button class="action-button" onclick="removerItem(${index})" style="padding: 5px 10px; font-size: 12px;">Remover</button></td>
                `;
            });
        }

        function atualizarEstatisticas() {
            const totalAnalises = dadosFiltrados.length;
            const naoConformidades = dadosFiltrados.filter(item => item.status === 'reprovado').length; // Apenas reprovados
            const taxaConformidade = totalAnalises > 0 ? ((totalAnalises - naoConformidades) / totalAnalises * 100).toFixed(1) : 0;
            
            document.getElementById('total-analises').textContent = totalAnalises;
            document.getElementById('total-nao-conformidades').textContent = naoConformidades;
            document.getElementById('taxa-conformidade').textContent = taxaConformidade + '%';
        }

        function inicializarGraficos() {
            // Gráfico de conformidade
            const ctxConformidade = document.getElementById('grafico-conformidade').getContext('2d');
            chartConformidade = new Chart(ctxConformidade, {
                type: 'doughnut',
                data: {
                    labels: ['Aprovado', 'Reprovado'], // Removido 'Atenção'
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#28A745', '#DC3545'] // Cores para Aprovado e Reprovado
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuição de Conformidade'
                        },
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'var(--texto-escuro)'
                            }
                        }
                    }
                }
            });
            
            // Gráfico de tendência
            const ctxTendencia = document.getElementById('grafico-tendencia').getContext('2d');
            chartTendencia = new Chart(ctxTendencia, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Não Conformidades por Dia',
                        data: [],
                        borderColor: 'var(--reprovado)', 
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1,
                        fill: true 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendência de Não Conformidades'
                        },
                        legend: { display: false } 
                    },
                    scales: {
                        x: {
                            type: 'time', 
                            time: {
                                unit: 'day', 
                                tooltipFormat: 'dd/MM/yyyy',
                                displayFormats: {
                                    day: 'dd/MM/yyyy'
                                }
                            },
                            title: { display: true, text: 'Data' },
                            ticks: { color: 'var(--texto-escuro)' },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Nº de Não Conformidades' },
                            ticks: { color: 'var(--texto-escuro)' },
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        }
                    }
                }
            });

            // Aux function for dimension chart options
            const getDimensionChartOptions = (title, dimensao) => ({ // Pass dimensao string to get formatting
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: title, color: 'var(--vinho-escuro)' },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    const format = dimensionFormatProps[dimensao];
                                    label += context.parsed.y.toFixed(format.decimalPlaces) + ' ' + format.unit;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'Amostras (Ordem de Análise)', color: 'var(--vinho-escuro)' },
                        ticks: { color: 'var(--texto-escuro)' },
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    },
                    y: { 
                        title: { display: true, text: `${dimensionFormatProps[dimensao].unit}`, color: 'var(--vinho-escuro)' },
                        ticks: { color: 'var(--texto-escuro)' },
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    }
                }
            });

            // Gráfico Peso
            const ctxPeso = document.getElementById('grafico-peso').getContext('2d');
            chartPeso = new Chart(ctxPeso, {
                type: 'line', 
                data: {
                    labels: [], 
                    datasets: [{
                        label: 'Peso (g)',
                        data: [],
                        backgroundColor: 'rgba(255, 215, 0, 0.5)', 
                        borderColor: 'var(--dourado)',
                        pointRadius: 4,
                        pointBackgroundColor: 'var(--dourado)',
                        pointBorderColor: 'var(--dourado)', // Adicionado para consistência
                        tension: 0.1,
                        fill: false 
                    }]
                },
                options: getDimensionChartOptions('Peso das Amostras', 'peso')
            });

            // Gráfico Comprimento
            const ctxComprimento = document.getElementById('grafico-comprimento').getContext('2d');
            chartComprimento = new Chart(ctxComprimento, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Comprimento (cm)',
                        data: [],
                        backgroundColor: 'rgba(40, 167, 69, 0.5)', 
                        borderColor: 'var(--aprovado)',
                        pointRadius: 4,
                        pointBackgroundColor: 'var(--aprovado)',
                        pointBorderColor: 'var(--aprovado)', // Adicionado para consistência
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: getDimensionChartOptions('Comprimento das Amostras', 'comprimento')
            });

            // Gráfico Altura (Agora será reprovado se estiver fora do ideal)
            const ctxAltura = document.getElementById('grafico-altura').getContext('2d');
            chartAltura = new Chart(ctxAltura, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Altura (cm)',
                        data: [],
                        backgroundColor: 'rgba(220, 53, 69, 0.5)', /* Cor de reprovado */
                        borderColor: 'var(--reprovado)', /* Cor de reprovado */
                        pointRadius: 4,
                        pointBackgroundColor: 'var(--reprovado)',
                        pointBorderColor: 'var(--reprovado)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: getDimensionChartOptions('Altura das Amostras', 'altura')
            });

            // Gráfico Largura
            const ctxLargura = document.getElementById('grafico-largura').getContext('2d');
            chartLargura = new Chart(ctxLargura, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Largura (cm)',
                        data: [],
                        backgroundColor: 'rgba(220, 53, 69, 0.5)', 
                        borderColor: 'var(--reprovado)',
                        pointRadius: 4,
                        pointBackgroundColor: 'var(--reprovado)',
                        pointBorderColor: 'var(--reprovado)', // Adicionado para consistência
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: getDimensionChartOptions('Largura das Amostras', 'largura')
            });

            // Gráfico por Produto
            const ctxPorProduto = document.getElementById('grafico-por-produto').getContext('2d');
            chartPorProduto = new Chart(ctxPorProduto, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nº de Não Conformidades',
                        data: [],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9900', '#66CDAA'] 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Não Conformidades por Produto' },
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Produto' },
                            ticks: { color: 'var(--texto-escuro)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Contagem' },
                            ticks: { color: 'var(--texto-escuro)', stepSize: 1 }
                        }
                    }
                }
            });
        }

        function atualizarGraficos() {
            // Atualizar gráfico de conformidade
            const aprovados = dadosFiltrados.filter(item => item.status === 'aprovado').length;
            const reprovados = dadosFiltrados.filter(item => item.status === 'reprovado').length; // Reclassificados

            chartConformidade.data.datasets[0].data = [aprovados, reprovados]; // Removido 'atencao' do array
            chartConformidade.update();
            
            // Atualizar gráfico de tendência
            const naoConformidadesPorDia = {};
            dadosFiltrados.forEach(item => {
                if (item.status === 'reprovado') { // Apenas reprovado agora
                    const data = new Date(item.timestamp).toISOString().split('T')[0]; 
                    naoConformidadesPorDia[data] = (naoConformidadesPorDia[data] || 0) + 1;
                }
            });
            
            const datasOrdenadas = Object.keys(naoConformidadesPorDia).sort();
            const valores = datasOrdenadas.map(data => naoConformidadesPorDia[data]);
            
            chartTendencia.data.labels = datasOrdenadas; 
            chartTendencia.data.datasets[0].data = valores;
            chartTendencia.update();

            // Update dimension-specific charts (Peso, Comprimento, Altura, Largura)
            const chartsByDimension = {
                peso: chartPeso,
                comprimento: chartComprimento,
                altura: chartAltura,
                largura: chartLargura
            };

            ['peso', 'comprimento', 'altura', 'largura'].forEach(dimensao => {
                const dadosDimensao = dadosFiltrados.filter(item => item.dimensao === dimensao).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                const chart = chartsByDimension[dimensao];
                
                if (chart) {
                    const pontos = dadosDimensao.map((item, index) => ({
                        x: index + 1, 
                        y: item.valor
                    }));
                    
                    chart.data.labels = pontos.map(p => `A${p.x}`); 
                    chart.data.datasets[0].data = pontos;
                    chart.update();
                }
            });
            
            // Atualizar gráfico por produto
            const naoConformidadesPorProduto = {};
            dadosFiltrados.forEach(item => {
                if (item.status === 'reprovado') { // Apenas reprovado agora
                    naoConformidadesPorProduto[item.produto] = (naoConformidadesPorProduto[item.produto] || 0) + 1;
                }
            });
            
            const produtos = Object.keys(naoConformidadesPorProduto);
            const valoresProdutos = produtos.map(produto => naoConformidadesPorProduto[produto]);
            
            chartPorProduto.data.labels = produtos;
            chartPorProduto.data.datasets[0].data = valoresProdutos;
            chartPorProduto.update();
        }

        function limparFiltros() {
            document.getElementById('filtro-produto').value = '';
            document.getElementById('filtro-data-inicial').value = '';
            document.getElementById('filtro-data-final').value = '';
            document.getElementById('filtro-conformidade').value = '';
            document.getElementById('filtro-dimensao').value = '';
            aplicarFiltros();
        }

        function exportarDados() {
            if (dadosFiltrados.length === 0) {
                alert('Nenhum dado para exportar!');
                return;
            }
            
            const headers = ['Data/Hora', 'Produto', 'Código', 'Dimensão', 'Valor', 'Limite Min', 'Limite Max', 'Status', 'Desvio'];
            const csvContent = [
                headers.join(','),
                ...dadosFiltrados.map(item => {
                    // Use formatProps to get the correct decimal places for 'Valor'
                    const format = dimensionFormatProps[item.dimensao] || { decimalPlaces: 2 }; // Default to 2 if not found
                    const formattedValue = item.valor.toFixed(format.decimalPlaces);

                    return [
                        new Date(item.timestamp).toLocaleString('pt-BR'),
                        `"${item.produto}"`, 
                        item.codigo,
                        item.dimensao,
                        formattedValue, // Use formatted value
                        item.limiteMin, // Already formatted as string "N/A" or number.toFixed
                        item.limiteMax, // Already formatted as string "N/A" or number.toFixed
                        item.status,
                        item.desvio.toFixed(2)
                    ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `historico_qualidade_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function gerarRelatorioNaoConformidade() {
            const naoConformidades = dadosFiltrados.filter(item => item.status === 'reprovado'); // Apenas reprovados
            
            if (naoConformidades.length === 0) {
                alert('Nenhuma não conformidade encontrada nos dados filtrados!');
                return;
            }
            
            const relatorioWindow = window.open('', '_blank');
            
            const agrupamento = {};
            naoConformidades.forEach(item => {
                const chave = `${item.produto}_${item.dimensao}`;
                if (!agrupamento[chave]) {
                    agrupamento[chave] = {
                        produto: item.produto,
                        dimensao: item.dimensao,
                        casos: []
                    };
                }
                agrupamento[chave].casos.push(item);
            });
            
            let htmlRelatorio = `
                <html>
                <head>
                    <title>Relatório de Não Conformidades</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        h1 { color: #800020; border-bottom: 2px solid #800020; padding-bottom: 5px; }
                        h2 { color: #B03A5A; margin-top: 30px; border-bottom: 1px solid #B03A5A; padding-bottom: 3px; }
                        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .reprovado { color: #DC3545; font-weight: bold; }
                        /* .atencao { color: #FFC107; font-weight: bold; } */ /* Removido */
                        .summary { background-color: #f9f9f9; padding: 15px; margin: 20px 0; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Não Conformidades</h1>
                    <p><strong>Data do Relatório:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                    <p><strong>Total de Não Conformidades Listadas:</strong> ${naoConformidades.length}</p>
                    
                    `;
            
            Object.values(agrupamento).forEach(grupo => {
                htmlRelatorio += `
                    <h2>${grupo.produto} - ${grupo.dimensao.charAt(0).toUpperCase() + grupo.dimensao.slice(1)}</h2>
                    <table>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Valor</th>
                            <th>Limite Min</th>
                            <th>Limite Max</th>
                            <th>Status</th>
                            <th>Desvio</th>
                        </tr>
                `;
                
                grupo.casos.forEach(caso => {
                    const statusClass = 'reprovado'; // Agora tudo é reprovado se não for aprovado
                    // Get format props for this specific dimension to format 'Valor' in the report
                    const format = dimensionFormatProps[caso.dimensao] || { decimalPlaces: 2 };
                    htmlRelatorio += `
                        <tr>
                            <td>${new Date(caso.timestamp).toLocaleString('pt-BR')}</td>
                            <td>${caso.valor.toFixed(format.decimalPlaces)}</td>
                            <td>${caso.limiteMin}</td>
                            <td>${caso.limiteMax}</td>
                            <td class="${statusClass}">${caso.status.charAt(0).toUpperCase() + caso.status.slice(1)}</td>
                            <td>${caso.desvio.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                htmlRelatorio += '</table>';
            });
            
            htmlRelatorio += '</body></html>';
            
            relatorioWindow.document.write(htmlRelatorio);
            relatorioWindow.document.close();
        }

        function removerItem(index) {
            if (confirm('Deseja realmente remover esta amostra do histórico exibido? (Aviso: A remoção permanente do armazenamento local para uma única amostra é mais complexa e não será realizada agora).')) {
                const itemToRemove = dadosFiltrados[index];
                
                // Remover do array dadosHistorico (em memória)
                const indexInOriginal = dadosHistorico.findIndex(originalItem =>
                    originalItem.sessionId === itemToRemove.sessionId && 
                    originalItem.dimensao === itemToRemove.dimensao &&
                    originalItem.valor === itemToRemove.valor &&
                    originalItem.timestamp === itemToRemove.timestamp 
                );

                if (indexInOriginal !== -1) {
                    dadosHistorico.splice(indexInOriginal, 1); 
                    showMessage('Amostra removida da visualização atual.', 'success');
                } else {
                    console.warn("Item não encontrado no dadosHistorico original para remoção em memória. Isso pode ocorrer se o item já foi removido.");
                    showMessage('Não foi possível encontrar o item para remover.', 'error');
                }

                aplicarFiltros(); 
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                background-color: ${type === 'success' ? '#28A745' : type === 'error' ? '#DC3545' : '#FFC107'};
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (document.body.contains(messageDiv)) { 
                    document.body.removeChild(messageDiv);
                }
            }, 3000);
        }

        function printScreen() {
            window.print();
        }
    </script>
</body>
</html>